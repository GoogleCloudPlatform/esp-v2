# ESPv2 Configurations

This directory contains examples of how to configure ESPv2.

Each folder contains three files:

1. **openapi_swagger.json**:  API producer defined [OpenAPI Specification](https://github.com/OAI/OpenAPI-Specification).

2. **service_config_generated.json**: Service configuration generated by Google Service Management.
To generate this, deploy `openapi_swagger.json` to service management:

```shell script
gcloud endpoints services deploy ./examples/$DIRECTORY/openapi_swagger.json
```

Then run:

```shell script
gcloud endpoints configs describe "${CONFIG_ID}" \
  --project="${PROJECT}" \
  --service="${SERVICE}" \
  --format=json \
  > service.json
```

All the examples can be deployed to the `cloudesf-testing` GCP project without changes to the `host` field.

3. **envoy_config.json**: Envoy static bootstrap configuration generated by [Config Manager](../src/go/README.md)
for the corresponding `service_config_generated.json`.  It is formatted by "python -m json.tool"

There are a few more configurations in the [internal testdata folder](./testdata/README.md) directory,
but these are primarily for ESPv2 developers and testing.


## [Auth](auth)

Configurations of JWT Authn filter.

- OpenAPI `securityDefinitions` are converted to JWT Authn `providers`.
- OpenAPI per-path `security` rules are converted to JWT Authn `requirements`.

## [Dynamic Routing](dynamic_routing)

Configurations of Dynamic Routing, where ESPv2 acts as an API Gateway. 
Google's OpenAPI `x-google-backend` extension is converted into:

- The Envoy `routeConfig` for host rewrite to the remote backend.
- The [Path Rewrite](../src/envoy/http/path_rewrite/README.md) filter for path rewrite to the remote backend.
- The [Backend Auth](../src/envoy/http/backend_auth/README.md) filter for authentication with the remote backend.

## [gRPC Dynamic Routing](grpc_dynamic_routing)

Configurations of gRPC Dynamic Routing, where ESPv2 acts as an API Gateway.
Similar to the Dynamic Routing example above, but:

- Configures routes for both gRPC and HTTP requests.
- Configures the gRPC Transcoding filter.
- Configures the [Service Control](../src/envoy/http/service_control/README.md) filter.

**Note**: When updating the service config, you must call Service Management directly.
Otherwise, the proto descriptor will not be included.

```shell script
curl --fail -o "service.json" -H "Authorization: Bearer $(gcloud auth print-access-token)" \
    "https://servicemanagement.googleapis.com/v1/services/${SERVICE}/configs/${CONFIG_ID}?view=FULL"
```

## [Service Control](service_control)

Configurations of authorization by API key, limiting by quota, and reporting logs / metrics.

- Configures the [Service Control](../src/envoy/http/service_control/README.md) filter.
